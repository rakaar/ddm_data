# Reading Lapse Parameters Pickle File

## Overview

The file `lapse_parameters_all_animals.pkl` contains:
- **Lapse probability parameters** (`lapse_prob` and `lapse_prob_right`) from Vanilla+Lapse and Norm+Lapse models
- **Per-trial log-likelihoods** for all 4 models: Vanilla, Vanilla+Lapse, Norm, Norm+Lapse
- **Trial counts** (n_valid, n_aborts, n_trials)

**Location:** `fit_animal_by_animal/lapse_parameters_all_animals.pkl`

**Generated by:** `compare_vanilla_norm_lapse_loglike_v2_div_by_N_with_aborts.py`

---

## File Structure

The pickle file contains a **dictionary** with the following structure:

```python
{
    (batch, animal): {
        'batch': str,              # e.g., 'LED8'
        'animal': int,             # e.g., 105
        'vanilla_lapse': {
            'lapse_prob': float,              # Overall lapse probability (Vanilla+Lapse model)
            'lapse_prob_right': float,        # Probability of lapsing to the right (Vanilla+Lapse model)
            'loglike_per_trial': float        # (valid_loglike + abort_loglike) / (n_valid + n_aborts)
        },
        'norm_lapse': {
            'lapse_prob': float,              # Overall lapse probability (Norm+Lapse model)
            'lapse_prob_right': float,        # Probability of lapsing to the right (Norm+Lapse model)
            'loglike_per_trial': float        # (valid_loglike + abort_loglike) / (n_valid + n_aborts)
        },
        'vanilla': {
            'loglike_per_trial': float        # (valid_loglike + abort_loglike) / (n_valid + n_aborts)
        },
        'norm': {
            'loglike_per_trial': float        # (valid_loglike + abort_loglike) / (n_valid + n_aborts)
        },
        'n_trials': int,           # Total trials = n_valid + n_aborts
        'n_valid': int,            # Number of valid trials
        'n_aborts': int            # Number of abort trials
    },
    ...
}
```

### Key Details:
- **Keys:** `(batch, animal)` tuples, e.g., `('LED8', 105)`
- **Values:** Dictionary containing batch name, animal ID, lapse parameters, per-trial log-likelihoods for all 4 models, and trial counts
- **Log-likelihood per trial:** Computed as `(valid_loglike + abort_loglike) / (n_valid + n_aborts)` where abort log-likelihood is identical across all models

---

## How to Read the File

### Basic Loading

```python
import pickle
import os

# Load the pickle file
base_dir = '/home/rlab/raghavendra/ddm_data/fit_animal_by_animal'
pkl_path = os.path.join(base_dir, 'lapse_parameters_all_animals.pkl')

with open(pkl_path, 'rb') as f:
    lapse_params = pickle.load(f)

# Print available animals
print(f"Total animals: {len(lapse_params)}")
print(f"Available (batch, animal) pairs: {list(lapse_params.keys())[:5]}...")  # Show first 5
```

### Accessing Data for a Specific Animal

```python
# Example: Get lapse parameters and log-likelihoods for LED8, animal 105
batch = 'LED8'
animal = 105
key = (batch, animal)

if key in lapse_params:
    data = lapse_params[key]
    
    # Lapse parameters
    vanilla_lapse_prob = data['vanilla_lapse']['lapse_prob']
    vanilla_lapse_prob_right = data['vanilla_lapse']['lapse_prob_right']
    norm_lapse_prob = data['norm_lapse']['lapse_prob']
    norm_lapse_prob_right = data['norm_lapse']['lapse_prob_right']
    
    # Per-trial log-likelihoods for all 4 models
    vanilla_loglike = data['vanilla']['loglike_per_trial']
    vanilla_lapse_loglike = data['vanilla_lapse']['loglike_per_trial']
    norm_loglike = data['norm']['loglike_per_trial']
    norm_lapse_loglike = data['norm_lapse']['loglike_per_trial']
    
    # Trial counts
    n_trials = data['n_trials']
    n_valid = data['n_valid']
    n_aborts = data['n_aborts']
    
    print(f"Animal: {batch}_{animal}")
    print(f"\nLapse Parameters:")
    print(f"  Vanilla+Lapse lapse_prob: {vanilla_lapse_prob:.4f}")
    print(f"  Vanilla+Lapse lapse_prob_right: {vanilla_lapse_prob_right:.4f}")
    print(f"  Norm+Lapse lapse_prob: {norm_lapse_prob:.4f}")
    print(f"  Norm+Lapse lapse_prob_right: {norm_lapse_prob_right:.4f}")
    
    print(f"\nLog-Likelihood Per Trial:")
    print(f"  Vanilla: {vanilla_loglike:.6f}")
    print(f"  Vanilla+Lapse: {vanilla_lapse_loglike:.6f}")
    print(f"  Norm: {norm_loglike:.6f}")
    print(f"  Norm+Lapse: {norm_lapse_loglike:.6f}")
    
    print(f"\nTrials:")
    print(f"  Total: {n_trials} (Valid: {n_valid}, Aborts: {n_aborts})")
else:
    print(f"Animal {batch}_{animal} not found in dataset")
```

### Iterating Through All Animals

```python
# Loop through all animals
for (batch, animal), data in lapse_params.items():
    vanilla_lp = data['vanilla_lapse']['lapse_prob']
    norm_lp = data['norm_lapse']['lapse_prob']
    
    print(f"{batch}_{animal}: Vanilla={vanilla_lp:.4f}, Norm={norm_lp:.4f}")
```

### Converting to Pandas DataFrame

```python
import pandas as pd

# Create a list of rows for DataFrame
rows = []
for (batch, animal), data in lapse_params.items():
    rows.append({
        'batch': batch,
        'animal': animal,
        'vanilla_lapse_prob': data['vanilla_lapse']['lapse_prob'],
        'vanilla_lapse_prob_right': data['vanilla_lapse']['lapse_prob_right'],
        'norm_lapse_prob': data['norm_lapse']['lapse_prob'],
        'norm_lapse_prob_right': data['norm_lapse']['lapse_prob_right'],
        'vanilla_loglike_per_trial': data['vanilla']['loglike_per_trial'],
        'vanilla_lapse_loglike_per_trial': data['vanilla_lapse']['loglike_per_trial'],
        'norm_loglike_per_trial': data['norm']['loglike_per_trial'],
        'norm_lapse_loglike_per_trial': data['norm_lapse']['loglike_per_trial'],
        'n_trials': data['n_trials'],
        'n_valid': data['n_valid'],
        'n_aborts': data['n_aborts']
    })

df = pd.DataFrame(rows)
print(df.head())

# Sort by batch and animal
df = df.sort_values(['batch', 'animal']).reset_index(drop=True)
```

### Filtering by Batch

```python
# Get all animals from a specific batch
batch_name = 'LED8'
batch_animals = {k: v for k, v in lapse_params.items() if k[0] == batch_name}

print(f"Animals in {batch_name}: {len(batch_animals)}")
for (batch, animal), data in batch_animals.items():
    print(f"  Animal {animal}: vanilla_lapse_prob = {data['vanilla_lapse']['lapse_prob']:.4f}")
```

### Computing Statistics

```python
import numpy as np

# Extract all vanilla lapse probabilities
vanilla_lapse_probs = [data['vanilla_lapse']['lapse_prob'] 
                       for data in lapse_params.values() 
                       if data['vanilla_lapse']['lapse_prob'] is not None]

# Compute statistics
print(f"Vanilla+Lapse lapse_prob statistics:")
print(f"  Mean: {np.mean(vanilla_lapse_probs):.4f}")
print(f"  Median: {np.median(vanilla_lapse_probs):.4f}")
print(f"  Std: {np.std(vanilla_lapse_probs):.4f}")
print(f"  Min: {np.min(vanilla_lapse_probs):.4f}")
print(f"  Max: {np.max(vanilla_lapse_probs):.4f}")
```

### Comparing Vanilla+Lapse vs Norm+Lapse

```python
# Compare lapse parameters between models
import matplotlib.pyplot as plt

vanilla_lps = []
norm_lps = []

for data in lapse_params.values():
    v_lp = data['vanilla_lapse']['lapse_prob']
    n_lp = data['norm_lapse']['lapse_prob']
    if v_lp is not None and n_lp is not None:
        vanilla_lps.append(v_lp)
        norm_lps.append(n_lp)

# Scatter plot
plt.figure(figsize=(8, 8))
plt.scatter(vanilla_lps, norm_lps, alpha=0.6)
plt.plot([0, 1], [0, 1], 'r--', label='y=x')
plt.xlabel('Vanilla+Lapse lapse_prob')
plt.ylabel('Norm+Lapse lapse_prob')
plt.title('Lapse Probability: Vanilla+Lapse vs Norm+Lapse')
plt.legend()
plt.grid(True, alpha=0.3)
plt.show()

# Correlation
correlation = np.corrcoef(vanilla_lps, norm_lps)[0, 1]
print(f"Correlation: {correlation:.3f}")
```

---

## Working with Log-Likelihoods

### Accessing Per-Trial Log-Likelihood

```python
# Per-trial log-likelihoods are already computed in the pickle file
for (batch, animal), data in lapse_params.items():
    vanilla_ll_per_trial = data['vanilla']['loglike_per_trial']
    vanilla_lapse_ll_per_trial = data['vanilla_lapse']['loglike_per_trial']
    norm_ll_per_trial = data['norm']['loglike_per_trial']
    norm_lapse_ll_per_trial = data['norm_lapse']['loglike_per_trial']
    
    print(f"{batch}_{animal}:")
    print(f"  Vanilla: {vanilla_ll_per_trial:.6f}")
    print(f"  Vanilla+Lapse: {vanilla_lapse_ll_per_trial:.6f}")
    print(f"  Norm: {norm_ll_per_trial:.6f}")
    print(f"  Norm+Lapse: {norm_lapse_ll_per_trial:.6f}")
```

### Model Comparison: Log-Likelihood Improvements

```python
import numpy as np

# Compare log-likelihood improvements (already per trial)
improvements = {
    'vanilla_lapse_vs_vanilla': [],
    'vanilla_lapse_vs_norm': [],
    'norm_lapse_vs_norm': [],
    'vanilla_lapse_vs_norm_lapse': []
}

for data in lapse_params.values():
    # Check if all models have valid loglike_per_trial values
    if all(data[model].get('loglike_per_trial') is not None 
           for model in ['vanilla', 'norm', 'vanilla_lapse', 'norm_lapse']):
        
        # Vanilla+Lapse vs Vanilla
        improvements['vanilla_lapse_vs_vanilla'].append(
            data['vanilla_lapse']['loglike_per_trial'] - data['vanilla']['loglike_per_trial']
        )
        
        # Vanilla+Lapse vs Norm
        improvements['vanilla_lapse_vs_norm'].append(
            data['vanilla_lapse']['loglike_per_trial'] - data['norm']['loglike_per_trial']
        )
        
        # Norm+Lapse vs Norm
        improvements['norm_lapse_vs_norm'].append(
            data['norm_lapse']['loglike_per_trial'] - data['norm']['loglike_per_trial']
        )
        
        # Vanilla+Lapse vs Norm+Lapse
        improvements['vanilla_lapse_vs_norm_lapse'].append(
            data['vanilla_lapse']['loglike_per_trial'] - data['norm_lapse']['loglike_per_trial']
        )

# Print summary statistics
for comparison, values in improvements.items():
    if values:
        print(f"\n{comparison}:")
        print(f"  Mean: {np.mean(values):.4f}")
        print(f"  Median: {np.median(values):.4f}")
        print(f"  Std: {np.std(values):.4f}")
        print(f"  Min: {np.min(values):.4f}")
        print(f"  Max: {np.max(values):.4f}")
```

### Visualizing Model Comparisons

```python
import matplotlib.pyplot as plt
import numpy as np

# Extract data
animals = []
vanilla_lapse_vs_vanilla = []
norm_lapse_vs_norm = []

for (batch, animal), data in lapse_params.items():
    animals.append(f"{batch}_{animal}")
    
    vanilla_lapse_vs_vanilla.append(
        data['vanilla_lapse']['loglike_per_trial'] - data['vanilla']['loglike_per_trial']
    )
    
    norm_lapse_vs_norm.append(
        data['norm_lapse']['loglike_per_trial'] - data['norm']['loglike_per_trial']
    )

# Bar plot
fig, axes = plt.subplots(2, 1, figsize=(14, 10))
x_pos = np.arange(len(animals))

# Vanilla+Lapse vs Vanilla
ax1 = axes[0]
colors1 = ['green' if v > 0 else 'red' for v in vanilla_lapse_vs_vanilla]
ax1.bar(x_pos, vanilla_lapse_vs_vanilla, color=colors1, alpha=0.7)
ax1.axhline(y=0, color='black', linestyle='-', linewidth=0.5)
ax1.set_ylabel('ΔLog-Likelihood / N_trials')
ax1.set_title('Vanilla+Lapse vs Vanilla')
ax1.set_xticks(x_pos)
ax1.set_xticklabels(animals, rotation=45, ha='right')
ax1.grid(axis='y', alpha=0.3)

# Norm+Lapse vs Norm
ax2 = axes[1]
colors2 = ['green' if v > 0 else 'red' for v in norm_lapse_vs_norm]
ax2.bar(x_pos, norm_lapse_vs_norm, color=colors2, alpha=0.7)
ax2.axhline(y=0, color='black', linestyle='-', linewidth=0.5)
ax2.set_ylabel('ΔLog-Likelihood / N_trials')
ax2.set_title('Norm+Lapse vs Norm')
ax2.set_xticks(x_pos)
ax2.set_xticklabels(animals, rotation=45, ha='right')
ax2.grid(axis='y', alpha=0.3)
ax2.set_xlabel('Animal')

plt.tight_layout()
plt.show()
```

### Grouping Animals by Lapse Probability

```python
# Separate animals into low and high lapse groups
LAPSE_THRESHOLD = 0.015  # 1.5%

low_lapse_animals = []
high_lapse_animals = []

for (batch, animal), data in lapse_params.items():
    vanilla_lp = data['vanilla_lapse']['lapse_prob']
    if vanilla_lp is not None:
        if vanilla_lp < LAPSE_THRESHOLD:
            low_lapse_animals.append((batch, animal, vanilla_lp))
        else:
            high_lapse_animals.append((batch, animal, vanilla_lp))

print(f"Low lapse (<{LAPSE_THRESHOLD*100:.1f}%): {len(low_lapse_animals)} animals")
print(f"High lapse (≥{LAPSE_THRESHOLD*100:.1f}%): {len(high_lapse_animals)} animals")

# Compute average log-likelihood improvements per group
low_lapse_improvements = []
high_lapse_improvements = []

for batch, animal, _ in low_lapse_animals:
    data = lapse_params[(batch, animal)]
    improvement = data['vanilla_lapse']['loglike_per_trial'] - data['vanilla']['loglike_per_trial']
    low_lapse_improvements.append(improvement)

for batch, animal, _ in high_lapse_animals:
    data = lapse_params[(batch, animal)]
    improvement = data['vanilla_lapse']['loglike_per_trial'] - data['vanilla']['loglike_per_trial']
    high_lapse_improvements.append(improvement)

print(f"\nLow lapse group mean improvement: {np.mean(low_lapse_improvements):.4f}")
print(f"High lapse group mean improvement: {np.mean(high_lapse_improvements):.4f}")
```

---

## Parameter Definitions

### `lapse_prob`
- **Type:** `float` (range: 0.0 to 1.0)
- **Definition:** Overall probability of a lapse trial (where the animal responds randomly regardless of stimulus)
- **Typical range:** Usually small, e.g., 0.01 to 0.15 (1% to 15%)

### `lapse_prob_right`
- **Type:** `float` (range: 0.0 to 1.0)
- **Definition:** Conditional probability of lapsing to the right given that a lapse occurs
- **Interpretation:**
  - `0.5`: Unbiased lapses (equal probability of lapsing left or right)
  - `> 0.5`: Right-biased lapses (animal preferentially lapses to the right)
  - `< 0.5`: Left-biased lapses (animal preferentially lapses to the left)

### Model Comparison
- **Vanilla+Lapse:** Lapse parameters fitted with vanilla (non-normalized) DDM
- **Norm+Lapse:** Lapse parameters fitted with normalized DDM (includes `rate_norm_l` parameter)
- Both models should produce similar lapse parameters if the lapse behavior is independent of the DDM variant

---

## Notes

1. **None values:** Some entries may have `None` values if the fit failed or data was unavailable
2. **Parameter source:** Lapse parameters are **mean values** sampled from VBMC posterior distributions (1M samples)
3. **Log-likelihood per trial calculation:** 
   - Formula: `loglike_per_trial = (valid_loglike + abort_loglike) / (n_valid + n_aborts)`
   - **All 4 models** include both **valid AND abort trials**
   - Abort log-likelihood is **identical across all models** (depends only on V_A, theta_A, t_A_aff)
   - Values are **already normalized** by total trials, so you can directly compare models without additional division
   - This ensures fair apples-to-apples comparisons between models
4. **Model details:** 
   - Vanilla: 6 parameters (rate_lambda, T_0, theta_E, w, t_E_aff, del_go)
   - Vanilla+Lapse: 8 parameters (adds lapse_prob, lapse_prob_right)
   - Norm: 7 parameters (adds rate_norm_l to Vanilla)
   - Norm+Lapse: 9 parameters (adds lapse_prob, lapse_prob_right to Norm)
5. **Trial counts:** 
   - `n_trials = n_valid + n_aborts`
   - Aborts filtered by: `abort_event == 3` and `TotalFixTime > T_trunc`

---

## Related Files

- **Script that generates this file:** `compare_vanilla_norm_lapse_loglike_v2_div_by_N_with_aborts.py`
- **CSV export:** `vanilla_norm_lapse_loglike_comparison_v2_div_by_N_with_aborts.csv` (includes log-likelihood comparisons)
- **VBMC fit files:**
  - Vanilla+Lapse: `oct_9_10_vanila_lapse_model_fit_files/vbmc_vanilla_tied_results_batch_{batch}_animal_{animal}_lapses_truncate_1s.pkl`
  - Norm+Lapse: `oct_9_10_norm_lapse_model_fit_files/vbmc_norm_tied_results_batch_{batch}_animal_{animal}_lapses_truncate_1s.pkl`

---

## Quick Usage Example

```python
import pickle

# Load the pickle file
with open('lapse_parameters_all_animals.pkl', 'rb') as f:
    lapse_params = pickle.load(f)

# Access specific animal
data = lapse_params[('LED8', 105)]

# Lapse parameters
print(f"Vanilla+Lapse lapse_prob: {data['vanilla_lapse']['lapse_prob']:.4f}")
print(f"Norm+Lapse lapse_prob: {data['norm_lapse']['lapse_prob']:.4f}")

# Per-trial log-likelihoods for all 4 models
print(f"\nLog-Likelihood Per Trial:")
print(f"  Vanilla: {data['vanilla']['loglike_per_trial']:.6f}")
print(f"  Vanilla+Lapse: {data['vanilla_lapse']['loglike_per_trial']:.6f}")
print(f"  Norm: {data['norm']['loglike_per_trial']:.6f}")
print(f"  Norm+Lapse: {data['norm_lapse']['loglike_per_trial']:.6f}")

# Log-likelihood improvement (already per trial)
improvement = data['vanilla_lapse']['loglike_per_trial'] - data['vanilla']['loglike_per_trial']
print(f"\nVanilla+Lapse improvement: {improvement:.6f} per trial")
```
